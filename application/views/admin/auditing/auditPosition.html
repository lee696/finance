<div class="widget-main">
	<div class="row">
		<!-- <h3 class="header smaller lighter blue">仓位审批</h3> -->
		<div class="actions" id="topTool">
			<div class="col-sx-4" style=" float: left;margin-right: 5px;">
				<input type="text" pts=0 sear="spm_approves.approve_code" placeholder="审批号">
            </div>
            <div class="col-sx-4" style=" float: left;margin-right: 5px;">
				<input type="text" pts=0 sear="spm_approves.customer_name" placeholder="企业名称">
            </div>
            <div class="col-sx-4" style=" float: left;margin-right: 5px;">
				<input type="text" pts=0 sear="spm_approves.customer_num" placeholder="企业编码">
            </div>
			<div class="col-sx-4" style=" float: left;margin-right: 5px;">
                <button id="search" title="搜索" class="btn btn-info btn-sm">
                    <i class="fa fa-search"></i>
                </button>
            </div>
            <div class="col-sx-4" style=" float: left;margin-right: 5px;">
                <button id="flush" title="刷新" type="button" class="btn btn-info btn-sm" style="background-color: #32CD32!important;">
                    <i class="fa fa-refresh"></i>
                </button>
            </div>
            <div class="col-sx-4" contentAuthority="200" style=" float: left;margin-right: 5px;">
                <button id="plSp" title="批量审批" class="btn sp btn-info btn-sm" style="background:#32CD32 !important;border-color:#32CD32 !important;">
					<i class="fa fa-check-circle-o"></i>
                </button>
            </div>
            <div class="col-sx-4" style=" float: left;margin-right: 5px;">
                <div id="filterBtns" style="display:inline-block;width:290px;">
                    <a href="#" class="" style="background: #E6E6E6;" data-status="all">全部</a>
                    <a href="#" class="" data-status="1"> 待审批</a>
                    <a href="#" class="" data-status="2"> 已通过</a>
                    <a href="#" class="" data-status="3"> 未通过</a>
                </div>
            </div>
		</div>
		<div class="auditing-data custom_table">
			<table id="dynamic-table">
				<thead>
					<tr class="thColor">	
						<th class="center">
							<label class="pos-rel">
                                <input type="checkbox" class="ace"/>
                                <span class="lbl"></span>
                            </label>
						</th>
						<th>操作</th>
						<th data-num="1">审批号</th>
						<th data-num="2">企业名称</th>
						<th data-num="3">企业编码</th>
						<th data-num="4">原仓位编码</th>
						<th data-num="5">新仓位</th>
						<th data-num="6">负责人</th>
						<th data-num="7">转移时间</th>
						<th data-num="8">审批员工</th>
						<th data-num="9">审批结果</th>
						<th data-num="10">审批时间</th>
						<th data-num="11">审批回复</th>
						<!-- <th data-num="7">审批时间</th>
						<th data-num="8">审批回复</th> -->
					</tr>
				</thead>
				<tbody id="datalist">
				</tbody>
			</table>
		</div>
		<div align="center" style="margin-top: 20px; margin-bottom: 20px;">
			<div align="left" style="padding-left: 15px; float: left; width: 10%;" id="num"></div>
			<!--<div id="pagination" style="float: left; width: 80%; height: 25px;"></div>-->
			<div id="pageBar" class="pagination"></div>
			<div align="right" style="float: right;  width: 10%;">
				<select style="width: 100px;" id="changePageNum">
					<option value="10">每页10条</option>
					<option value="20">每页20条</option>
					<option value="50">每页50条</option>
					<option value="100">每页100条</option>
					<option value="200">每页200条</option>
				</select>
			</div>
		</div>
	</div>

	<div class="label_popup" id="feedBack" style="position:fixed;top:0;right:0;bottom:0;left:0;z-index:1050;display:none;">
		<div style="width:400px;margin:39px auto;z-index:1060;background:#fff;position:relative;border:1px solid #ddd;
		    box-shadow:0px 0px 15px rgba(0, 0, 0, 0.2);">
			<div style="padding:15px;border-bottom:1px solid #ddd;">
				<span style="display: inline-block;">请填写驳回原因</span>
				<a href="javascript:;" class="close_label" style="float: right;"><i class="fa fa-times" aria-hidden="true"></i></a>
			</div>
			<div style="padding: 10px 50px;">
				<input type="text" width="200px" style="margin: auto;" id="labelName" />
				<!--<hr>-->
			</div>
			<div style="padding:15px;text-align:right;">
				<button class="close_label">关闭</button>
				<button class="hold">保存</button>
			</div>
		</div>
	</div>
	{% include 'admin/mark.html' %}
	{% include 'admin/customerDetail.html' %}
</div>
<script src="/resource/adimin/assets/js/src/public.js"></script>
<script type="text/javascript">
	$(function() {
		if(cs.approve_authority({name:'仓位',nodes:[200]})){
            $('[contentAuthority="200"]').show();
        }

		var order ='spm_approves.approve_result asc,spm_approves.id desc';
		var page_size = 10;//默认每页显示的条目数为 10 
		var approve_result = '';//审批状态
		var filter = '';//过滤条件

		//自定义table
		cs.custorm_check('#dynamic-table', '#datalist', true);
		
		var employees={};
		//获取所有员工
		ykp.doAjax({
			async:false,
			url: '/api/api_employees/f7',
			method: 'post',
			data: {
				filter: 'bmm_employees.is_del <> 1',
				select: 'bmm_employees.id,bmm_employees.name'
			},
			success: function(res) {
	            var data = res.data;
	              $('.advandced-search').select2({allowClear:true});
	              for(var i in data){
	                  employees[data[i]['id']] =data[i]['name'] ;
	                 $('.advandced-search').append(new Option(data[i]['name']));   
	             }
			}
		});	

		//改变每页显示的条目数
		changePage();
		function changePage(){
			$('#changePageNum').change(function() {
				page_size = $(this).val();
				ykp.setCookie('page_size',page_size);
				getList();
			})
		}

		//查看全部 | 待审批 | 已通过 | 未通过
		clickBtn();
		function clickBtn() {
			$('#topTool').on('click', 'a', function(item) {
				if (!$(this).hasClass('clc')) {
                    $(this).addClass('clc').siblings().removeClass('clc');
                }
				var status = $(this).attr('data-status');
				if(status != 'all'){
					approve_result = status;
				}else{
					approve_result = '';	
				}
				getList();
			})
		}

		$('#flush').click(function(){
			$('#topTool input').val('');
			filter = '';
			ykp.setCookie("filter", "");
			ykp.setCookie("where", "");
			getList();
		})
		$('#filterBtns a').mouseover(function(){
            $(this).addClass('over');
        })
        $('#filterBtns a').mouseout(function(){
            $(this).removeClass('over');
        })

		//普通搜索
		function general_search() {
			var data = {
				url: '/api/Api_approves/get_list',
				method: 'post',
				data: {
					limit:page_size,
					order:order
				}
			}
			cs.doSearch('#search', data, 'filter', false, function(res,_filter) {
				filter = _filter;
				if(res.data.items == "") {
					 setTimeout(function(){
                        ykp.prompt('暂无数据！');
                    },1000);
					$('#datalist').html('<tr><td colspan="30"><div class="table-actions clearfix"></div> <div style="color:#7d7d7d !important;text-align:center !important;" class="page">暂无数据</div></td></tr>');
					return ;
				} 
				addList(res);
			},'spm_approves.approve_type = 10 ' + (approve_result ? ('and spm_approves.approve_result = ' + approve_result) : ''));
		}

		//处理获取到的列表数据
		function addList(res){
			//审批权限为true可以审批,为false不可审批
            var spApp = cs.approve_authority({name:'仓位',nodes:[201]});
            var cxApp = cs.approve_authority({name:'仓位',nodes:[262]});

            var styles = [];
            $('#dynamic-table th').each(function(i,e){
                styles.push($(this).css('display'));
            });

			var data = res.data.items;
			var status = ['','待审批', '已通过', '未通过']; //审核状态
			var statusColor = ['','#dfba49', '#45b6af', '#f3565d'];
			var list = [];
			for(var i in data) {
				list.push(
					`<tr data-id="${data[i]['spm_approves.id']}"  data-status="${data[i]['spm_approves.approve_result']}">
                    	<td class="center">
                            <label class="pos-rel">
                                <input type="checkbox" name="check" class="ace"/>
                                <span class="lbl"></span>
                            </label>
                        </td>
                        <td>
                        <label class="pos-rel ">
	                       <a href="#" class="sp btOrange" data-status = "1" style="display: ${cxApp ? (data[i]['spm_approves.approve_result'] == 2 ?'inline-block' : 'none') : 'none'};color:#fff !important" contentAuthority="262" title="撤销"><i class="fa fa-rotate-left"></i></a>
	                        <a href="#" class="sp btGreen" data-status = "2" style="display: ${spApp ? (data[i]['spm_approves.approve_result'] == 1 ?'inline-block' : 'none') : 'none'};color:#fff !important" contentAuthority="201" title="通过"><i class="fa fa-check-circle-o"></i></a>
	                        <a href="#" class="sp btRed" data-status = "3" style="display: ${spApp ? (data[i]['spm_approves.approve_result'] == 1 ?'inline-block' : 'none') : 'none'};color:#fff !important" contentAuthority="201" title="驳回"><i class="fa fa-times-circle"></i></a>
	                    	</label>
	                    </td>
                        <td data-num="1" style="display:${styles[2]}">${data[i]['spm_approves.approve_code']}</td>
                        <td data-num="2" style="display:${styles[3]}">
                        	<label class="pos-rel" data-cid="${data[i]['spm_approves.customer_id']}" style="font-weight:500;">
                        		<a class="customerDetail" style="cursor:pointer;color:#337ab7;">${data[i]['spm_approves.customer_name']}
                        		<i class="iconBnt fa fa-info-circle" style="color:${data[i]['Remark'].length > 0 ? 'red' : ''}" data-rel="tooltip" data-placement="right" data-html="true" title="<p align='left'>aaaa123aaaaaa<br/>13213</p>" ></i>
                        	</label></a>
                        </td>
                        
                        <td data-num="3" style="display:${styles[4]}">
                        	${data[i]['spm_approves.customer_num']}
                        </td>
                        <td data-num="4" style="display:${styles[5]}">
                        	${data[i]['submitted_data']['old_pos_name'] + data[i]['submitted_data']['old_pos_num']}
                        </td>
                        <td data-num="5" style="display:${styles[6]}">
							${data[i]['submitted_data']['new_pos_name'] }
                        </td>
                        <td data-num="6" style="display:${styles[7]}">
                        	${data[i]['spm_approves.submit_employee_id']  ? (employees[data[i]['spm_approves.submit_employee_id']] || "") : ''}
                        </td>
                        
                        <td data-num="7" style="display:${styles[8]}">
                        	${data[i]['spm_approves.submit_time'] !='0' ? cs.getNowTime(data[i]['spm_approves.submit_time'],true) : ''}
                        </td>
                        <td data-num="8" style="display:${styles[9]}">${data[i]['approve_employee_name'] ? data[i]['approve_employee_name']['name'] : ""}</td>
	                    <td data-num="9" style="display:${styles[10]}"><label class="label" style=" background:${statusColor[data[i]['spm_approves.approve_result']]} ">${status[data[i]['spm_approves.approve_result']]}</label></td>
	                    <td data-num="10" style="display:${styles[11]}">${data[i]['spm_approves.approve_time'] != 0 ? cs.getNowTime(data[i]['spm_approves.approve_time'],true) : ''}</td>
	                    <td data-num="11" style="display:${styles[12]}">${data[i]['spm_approves.approve_reply']}</td>
                    </tr>`
				);
			}

			$('#datalist').html(list.join(''));
			
			$("[data-rel='tooltip']").tooltip();
			custom.get_custom_info();
			custom.showReamrk();

			$("#datalist tr").find('.sp').click(function() {
				var status = $(this).attr('data-status');
				var id = $(this).parents('tr').attr('data-id');
				if(status != '0'){
					changeStatus(status, id);
				}
			})
		}

		//批量审批
		batch_approve();
		function batch_approve(){
			$('#plSp').click(function() {
				var status = '',
					n = 0,
					Statu = false,
					coldata = []
				$('#datalist').find('input[type="checkbox"]:checked').each(function(i) {
					n++;
					status = $(this).parents('tr').attr('data-status') == 1 ? 2 : 1;

					if($(this).parents('tr').attr('data-status') == 3 || $(this).parents('tr').attr('data-status') == 2) {
						ykp.prompt('审批过的不能批量审批!');
						Statu = false;
						return false;
					}  else {
						coldata.push({
							id: $(this).parents('tr').attr('data-id'),
							approve_result: status
						});
						Statu = true;
					}
				})
				if(n == 0) {
					ykp.prompt('请选择再审批！');
					return false;
				} else {
					if(Statu) {
						ykp.doAjax({
							url: "/api/api_approves/batch_edit",
							method: 'post',
							data: {
								data: JSON.stringify(coldata),
								type: '10'
							},
							success: function(res) {
								ykp.prompt('审批成功');
								$('input.ace').prop('checked',false);
								getList();
							}
						})
					}
				}
			})
		}

		//获取列表数据
		getList(1);
		function getList(isInit) {
			if(isInit == 1){
				ykp.setCookie("filter", "");
				ykp.setCookie("where", "");
			}
			general_search();
			if(!cs.getSpStatus('仓位')) {
				ykp.prompt('暂时没有开启审批功能');
				return false;
			}
			var data = {
				type: 10,
				approve_result: approve_result,
				page_size:page_size,
				filter:filter,
				order:order,
				contentId: "#datalist", //默认排序
				initOrder: "", //初始化sort
				defaultOrder: order,
				params: [{
					id: "#dynamic-table",
					field: ["","","spm_approves.approve_code","spm_approves.customer_id", "spm_approves.customer_num",
					"", "","spm_approves.submit_employee_id","spm_approves.submit_time","approve_employee_id","spm_approves.approve_result","spm_approves.approve_time","spm_approves.approve_reply"]
				}]
			};
			if(!cs.getSpStatus('仓位')) {
					ykp.prompt('暂时没有开启审批功能');
					return false;
			}
			cs.spList(data, function(res) {
				if(res.data.items == "") {
					ykp.prompt("暂无数据");
					$('#datalist').html('<tr><td colspan="30"><div class="table-actions clearfix"></div> <div style="color:#7d7d7d !important;text-align:center !important;" class="page">暂无数据</div></td></tr>');
					return ;
				} 
				addList(res);
				// auditDetail();
			},'仓位');
			
		}

		//通过 |  驳回  |  撤销点击操作处理
		function changeStatus(status, id) {
			var data = {
				url: '/api/api_approves/edit_status',
				methods: 'post',
				data: {
					id: id,
					approve_result: status
				}
			}
			if(status == 3) {
				$('#feedBack').show();
				$('#feedBack .hold').click(function() {
					var approve_reply = $('#feedBack').find('input').val();
					if(approve_reply == '') {
						ykp.prompt('不能为空！');
						return false;
					}else {
						ykp.prompt('驳回成功！');
						data.data.approve_reply = approve_reply.trim();
					data.data.approve_reply = approve_reply;
					setStatus(data);
					$('.close_label').parents('.label_popup').fadeOut();
					}
					
				})
				cs.closePop();
			} else if(status == 1){
//              bootbox.confirm('确认撤销审批？', function(flag){
//                  if(flag){
//                      setStatus(data);
//                  }
//              })
           		layui.use('layer', function() {
						var layer = layui.layer;
						layer.confirm('确认撤销审批？', function(flag) {
							if(flag) {
						layer.closeAll();
						setStatus(data);
							}
						});
					})
            }else if(status == 2){
            	ykp.prompt('审批通过！');
            	setStatus(data);
            }else{
				setStatus(data);
			}

		}

		//向服务器发送异步请求
		function setStatus(data) {
			ykp.doAjax({
				url: data.url,
				methods: data.methods,
				data: data.data,
				success: function(res) {
	//				ykp.prompt('审批成功!');
					getList();
				}
			})
		}

		//全选 反选
		checkAll();
		function checkAll(){
			$('input.ace').click(function(){
				$('input[name="check"]').prop('checked',$(this)[0].checked);
			});
		}
	});
</script>