<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<meta charset="utf-8"/>
	<title>客户详情 - 财税系统</title>
	<meta name="description" content="overview &amp; stats"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="stylesheet" href="/resource/adimin/assets/css/bootstrap.css" />
	<link rel="stylesheet" href="/resource/adimin/assets/css/main/public.css"/>
    <link rel="stylesheet" href="/resource/adimin/layui/css/layui.css" />

    <style type="text/css">
		table{
			width:100%;
			border:1px solid #ddd;
			border-collapse: collapse;
		}
		.message td{
			border:1px solid #ddd;
			width:25%;
		    white-space: nowrap !important;
		    text-align: left;
		    padding: 5px !important;
		    height: 35px;
		}
		/*tbody tr td:before{
			height:50px;
		}*/
		.custom_table th,.custom_table td{
			border:1px solid #ddd;
		    white-space: nowrap !important;
		    text-align: left;
		    padding: 5px !important;
		    height: 40px;
		}
		.pagination>.active>a{
		    background:  #6FAED9 !important;
		    border: 1px solid  #6FAED9 !important;
		    color:#fff !important;
		}
		.unite-label{
			width: 10% !important;
			padding:5px 10px !important;
			height: 35px !important;
			text-align: left !important;
		}
		td[data-title]{
			width: 40% !important;
			text-align: left !important;
		}
		.month:before{
			content: none;
		}
		.basic_message td:before{
			content: none;
		}
		.glyphicon{
			margin-bottom: 0;
		}
		.basic_message td:before{
			height: 35px;
		} 
		.basic_message tr td:before{
			width: 0px !important;
			height: 0px !important;
		}
    </style>
	<script type="text/javascript" src="/resource/adimin/layui/layui.js" ></script>
</head>
<body>
	<div style="width:80%;margin:0 auto;">
		<div style="text-align:center;padding:20px;height:31px;">
			<div style="position:relative;">
				<label class="customer_name" style="font-size:24px;padding-right:5px;"></label>
				<span class="labels" style="position:absolute;top:9px;"></span>
			</div>
		</div>
		<div>
			<div class="custom_table" style="padding:20px 0;">
				<table style="width:100%;">
					<thead>
						<tr>
							<th>客户编码</th>
							<th>客户级别</th>
							<th>客户状态</th>
							<th>最后跟进人</th>
							<th>最后跟进时间</th>
							<th>所属仓位</th>
							<th>更多</th>
						</tr>
					</thead>
					<tbody class="basic_message">
						<tr>
							<td style="text-align: center;" basic="id"></td>
							<td style="text-align: center;" basic="rank"></td>
							<td style="text-align: center;" basic="status"></td>
							<td style="text-align: center;" follow=""></td>
							<td style="text-align: center;" follow=""></td>
							<td style="text-align: center;" position=""></td>
							<td style="text-align: center;">
								<label class="pos-rel">
									<select class="rele" style="position:relative;height:30px;min-width:180px;">
									<option value="">暂无数据</option>
								</select></label>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div style="padding-bottom:50px;">
			<div class="layui-collapse" lay-accordion lay-filter="one_level">
			  <div class="layui-colla-item" index="1">
			    <h2 class="layui-colla-title">摘要</h2>
			    <div class="layui-colla-content">
			    	<div>
						<div>
							<p style="margin:0 auto;padding-bottom:20px;padding:10px;background-color: #ccecff;text-align:center;font-size:16px;">待办任务</p>
						</div>
						<div>
							<div class="wait_finish_task" style="display:none;">
								<table>
									<tbody>
										<tr>

										</tr>
									</tbody>
								</table>
							</div>
							<div class="wait_finish_task">
								<div style="border:1px solid #ddd;text-align:center;height: 40px;line-height: 40px;">
									暂无数据
								</div>
							</div>
						</div>
					</div>
					<div>
						<div style="margin-top:30px;">
							<p style="margin:0 auto;padding:10px;background-color: #ccecff;text-align:center;font-size:16px;">最近联系记录</p>
						</div>
						<div class="recent_contact_record">

						</div>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="2">
			    <h2 class="layui-colla-title">信息</h2>
			    <div class="layui-colla-content">
			    	<div>
						<div>
							<table class="_message" style="border:1px solid #ddd;border-collapse:collapse;">
								<tr>
									<td class="unite-label">公司全称</td>
									<td data-title="name"></td>
									<td class="unite-label">统一社会信用代码</td>
									<td data-title="social_credit_code"></td>
								</tr>
								<tr>
									<td class="unite-label">客户编码</td>
									<td data-title="id"></td>
									<td class="unite-label">仓位编码</td>
									<td pos-id></td>
								</tr>
								<tr>
									<td class="unite-label">营业执照号</td>
									<td data-title="license_no"></td>
									<td class="unite-label">客户来源</td>
									<td data-title="source"></td>
								</tr>
								<tr>
									<td class="unite-label">法人证件号</td>
									<td data-title="corporation_card"></td>
									<td class="unite-label">法人姓名</td>
									<td data-title="corporation"></td>
								</tr>
								<tr>
									<td class="unite-label">注册日期</td>
									<td data-title="stablish_time"></td>
									<td class="unite-label">添加日期</td>
									<td data-title="create_at"></td>
								</tr>
								<tr>
									<td class="unite-label">注册资金</td>
									<td data-title="capital"></td>
									<td class="unite-label">省市区</td>
									<td data-title="area"></td>
								</tr>
								<tr>
									<td class="unite-label">详细地址</td>
									<td data-title="address"></td>
									<td class="unite-label">客户级别</td>
									<td data-title="rank"></td>
								</tr>
								<tr>
									<td class="unite-label">行业</td>
									<td data-title="industry"></td>
									<td class="unite-label">公司规模</td>
									<td data-title="scale"></td>
								</tr>
								<tr>
									<td class="unite-label">联系人</td>
									<td data-title="contacts"></td>
									<td class="unite-label">手机</td>
									<td data-title="phone"></td>
								</tr>
								<tr>
									<td class="unite-label">备注</td>
									<td colspan="4" data-title="remark"></td>
								</tr>
								<tr>
									<td class="unite-label">经营范围</td>
									<td colspan="4" data-title="range" style="white-space:normal !important;"></td>
								</tr>
							</table>
						</div>
						<div style="margin-top:20px;">
							<table class="_message" style="border:1px solid #ddd;border-collapse:collapse;">
								<tr>
									<td class="unite-label">税务类型</td>
									<td data-title="tax_type" ></td>
									<td class="unite-label">有无基本户</td>
									<td data-title="basic" ></td>
								</tr>
								<tr>
									<td class="unite-label">纳税识别号</td>
									<td data-title="ratepaying_no" ></td>
									<td class="unite-label">税务备注</td>
									<td data-title="remark" ></td>
								</tr>
								<tr>
									<td class="unite-label">国税编码</td>
									<td data-title="state_tax_no"></td>
									<td class="unite-label">国税密码</td>
									<td data-title="state_tax_pass"></td>
								</tr>
								<tr>
									<td class="unite-label">国税ca证书</td>
									<td data-title="gca"></td>
									<td class="unite-label">地税编码</td>
									<td data-title="local_tax_no"></td>
								</tr>
								<tr>
									<td class="unite-label">地税密码</td>
									<td data-title="local_tax_pass"></td>
									<td class="unite-label">地税ca证书</td>
									<td data-title="dca"></td>
								</tr>
								
							</table>
						</div>
						<div style="margin-top:20px;">
							<table class="_message" style="border:1px solid #ddd;border-collapse:collapse;">
								<tr>
									<td class="unite-label">客户状态</td>
									<td data-title="status" ></td>
									<td class="unite-label">最后修改人</td>
									<td data-title="update_by" ></td>
								</tr>
								<tr>
									<td class="unite-label">所属公海</td>
									<td data-title="type"></td>
									<td class="unite-label">失效原因</td>
									<td data-title="reason"></td>
								</tr>
								<tr>
									<td class="unite-label">失效操作人</td>
									<td data-title="voiduser"></td>
									<td class="unite-label">失效人所在部门</td>
									<td data-title="voiddept"></td>
								</tr>
								<tr>
									<td class="unite-label">创建人</td>
									<td data-title="create_id"></td>
									<td class="unite-label">创建人所在部门</td>
									<td data-title="create_dep"></td>
								</tr>
								
							</table>
						</div>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="3">
			    <h2 class="layui-colla-title">联系人</h2>
			    <div class="layui-colla-content">
			    	<div>
						<div>
							<table class="custom_table">
								<thead>
									<tr>
										<th>企业数</th>
										<th>姓名</th>
										<th>性别</th>
										<th>手机</th>
										<th>电话</th>
										<th>QQ</th>
										<th>是否关键决策人</th>
										<th>主要联系人</th>
									</tr>
								</thead>
								<tbody class="contracts_message">
									<!-- <tr>
										<td>李四</td>
											<td>男</td>
											<td>李四</td>
											<td>18926546552</td>
											<td>0755-86526354</td>
											<td>895564215</td>
											<td>李李</td>
									</tr> -->
								</tbody>
							</table>
						</div>
						<div align="center" style="margin-top: 20px; margin-bottom: 20px;">
							<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
							<!--<div id="pagination" style="float: left; width: 80%; height: 25px;"></div>-->
							<div class="pageBar pagination"></div>
							<div align="right" style="float: right;">
								<select style="width: 100px;height:30px;" class="changePageNum">
									<option value="10">每页10条</option>
									<option value="20">每页20条</option>
									<option value="50">每页50条</option>
									<option value="100">每页100条</option>
									<option value="200">每页200条</option>
								</select>
							</div>
							<div style="clear:both;"></div>
						</div>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="4">
			    <h2 class="layui-colla-title">服务</h2>
			    <div class="layui-colla-content service_message">
			    	
			    </div>
			  </div>
			  <div class="layui-colla-item" index="5">
			    <h2 class="layui-colla-title">团队</h2>
			    <div class="layui-colla-content team_message" >
			    	
			    </div>
			  </div>
			  <div class="layui-colla-item" index="6">
			    <h2 class="layui-colla-title">合同</h2>
			    <div class="layui-colla-content conract_message">
			    	
			    </div>
			  </div>
			  <div class="layui-colla-item" index="7">
			    <h2 class="layui-colla-title">收款</h2>
			    <div class="layui-colla-content">
			    	<!--<div>
						<table class="custom_table sk_jz">
							<thead>
								<tr>
									<th>订单编号</th>
									<th>欠费周期</th>
									<th>欠费金额</th>
									<th>1月</th>
									<th>2月</th>
									<th>3月</th>
									<th>4月</th>
									<th>5月</th>
									<th>6月</th>
									<th>7月</th>
									<th>8月</th>
									<th>9月</th>
									<th>10月</th>
									<th>11月</th>
									<th>12月</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>-->
                    <div style="margin-top: 20px;">
                    	<table class="custom_table sk_qt">
		                    <thead>
		                    <tr>
		                        <th data-num="1">收款编号</th>
									<th data-num="2">企业名称</th>
									<th data-num="3">订单编号</th>
									<th data-num="4">收款项目</th>
									<th data-num="5">状态</th>
									<th data-num="6">审批回复</th>
									<th data-num="7">收款日期</th>
									<th data-num="8">收款总额</th>
									<th data-num="9">收款方式</th>
									<th data-num="10">收款账户</th>
									<th data-num="11">收款人</th>
									<th data-num="12">备注</th>
		                    </tr>
		                    </thead>
		                    <tbody>
		                    </tbody>
		                </table>
                    </div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="8">
			    <h2 class="layui-colla-title">支出</h2>
			    <div class="layui-colla-content">
			    	<div>
						<table class="custom_table">
							<thead>
								<tr>
									<th>支出编号</th>
									<th>订单编号</th>
									<th>状态</th>
									<th>支出日期</th>
									<th>支出金额(元)</th>
									<th>支出类别</th>
									<th>支付方式</th>
									<th>支付账户</th>
									<th>负责人</th>
									<th>备注</th>
								</tr>
							</thead>
							<tbody class="expenditrue_message">
							</tbody>
						</table>
					</div>
					<div align="center" style="margin-top: 20px; margin-bottom: 20px;">
						<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
						<!--<div id="pagination" style="float: left; width: 80%; height: 25px;"></div>-->
						<div class="pageBar pagination"></div>
						<div align="right" style="float: right;">
							<select style="width: 100px;height:30px;" class="changePageNum">
								<option value="10">每页10条</option>
								<option value="20">每页20条</option>
								<option value="50">每页50条</option>
								<option value="100">每页100条</option>
								<option value="200">每页200条</option>
							</select>
						</div>
						<div style="clear:both;"></div>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="9">
			    <h2 class="layui-colla-title">开票</h2>
			    <div class="layui-colla-content">
			    	<div>
						<table class="custom_table">
							<thead>
								<tr>
									<th>开票申请号</th>
									<th>客户名称</th>
									<th>订单编号</th>
									<th>状态</th>
									<th>开票日期</th>
									<th>开票金额(元)</th>
									<th>开票类型</th>
									<th>发票号码</th>
									<th>抬头类型</th>
									<th>开票抬头</th>
									<th>社会统一信用码</th>
								</tr>
							</thead>
							<tbody class="billing_message">
							</tbody>
						</table>
					</div>
					<div align="center" style="margin-top: 20px; margin-bottom: 20px;">
						<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
						<!--<div id="pagination" style="float: left; width: 80%; height: 25px;"></div>-->
						<div class="pageBar pagination"></div>
						<div align="right" style="float: right;">
							<select style="width: 100px;height:30px;" class="changePageNum">
								<option value="10">每页10条</option>
								<option value="20">每页20条</option>
								<option value="50">每页50条</option>
								<option value="100">每页100条</option>
								<option value="200">每页200条</option>
							</select>
						</div>
						<div style="clear:both;"></div>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="10">
			  		<h2 class="layui-colla-title">物品</h2>
			    	<div class="layui-colla-content">
						<div class="layui-collapse" lay-accordion lay-filter="demo1">
							<div class="layui-colla-item">
								<h2 class="layui-colla-title">凭证仓</h2>
								<div class="layui-colla-content" index="0">
									<div class="custom_table">
										<table>
											<!-- <thead>
												<tr class="thColor ths">
													<th>盘点编码</th>
													<th>盘点日期</th>
													<th>仓库名称</th>
													<th>仓位</th>
													<th>库存物品</th>
													<th>库存数量</th>
													<th>盘点数量</th>
													<th>盘点差额</th>
													<th>盘点结果</th>
													<th>创建人</th>
													<th>创建时间</th>
												</tr>
											</thead> -->
											<tbody>
												<tr>
													<td style="text-align: center !important;color:#7d7d7d" colspan="30">暂无数据</td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- <div align="center" style="margin-top: 20px; margin-bottom: 20px;">
										<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
										<div class="pageBar pagination"></div>
										<div align="right" style="float: right;">
											<select style="width: 100px;" id="changePageNum">
												<option value="10">每页10条</option>
												<option value="20">每页20条</option>
												<option value="50">每页50条</option>
												<option value="100">每页100条</option>
												<option value="200">每页200条</option>
											</select>
										</div>
									</div> -->
								</div>
							</div>

							<div class="layui-colla-item">
								<h2 class="layui-colla-title">票据仓</h2>
								<div class="layui-colla-content" index="1">
									<div class="custom_table">
										<table class="dynamic-table">
											<!-- <thead>
												<tr>
													<th>入库单号</th>
													<th>入库类型</th>
													<th>仓库名称</th>
													<th>经办人</th>
													<th>入库时间</th>
													<th>入库物品</th>
													<th>入库数量</th>
													<th>创建人</th>
													<th>创建时间</th>
												</tr>
											</thead> -->
											<tbody>
												<tr>
													<td style="text-align: center !important;color:#7d7d7d" colspan="30">暂无数据</td>
												</tr>
												<!-- <tr>
													<td>测试</td>
													<td>2017-8-2 11:34:28</td>
													<td>张三</td>
													<td>测试</td>
													<td>2017-8-2 11:34:28</td>
													<td>张三</td>
													<td>测试</td>
													<td>2017-8-2 11:34:28</td>
													<td>
														<a href="javascript:;">编辑</a>&nbsp;&nbsp;
														<a href="javascript:;">删除</a>
													</td>
												</tr> -->
											</tbody>
										</table>
									</div>
		
									<!-- <div align="center" style="margin-top: 20px; margin-bottom: 20px;">
										<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
										<div class="pageBar pagination"></div>
										<div align="right" style="float: right;">
											<select style="width: 100px;" id="changePageNum">
												<option value="10">每页10条</option>
												<option value="20">每页20条</option>
												<option value="50">每页50条</option>
												<option value="100">每页100条</option>
												<option value="200">每页200条</option>
											</select>
										</div>
									</div> -->
								</div>
							</div>
							<div class="layui-colla-item">
								<h2 class="layui-colla-title">证件仓</h2>
								<div class="layui-colla-content" index="2">
									<div class="custom_table">
										<table>
											<!-- <thead>
												<tr class="thColor">
													<th>出库单号</th>
													<th>出库类型</th>
													<th>仓库名称</th>
													<th>经办人</th>
													<th>出库时间</th>
													<th>出库物品</th>
													<th>出库数量</th>
													<th>创建人</th>
													<th>创建时间</th>
												</tr>
											</thead> -->
											<tbody>
												<tr>
													<td style="text-align: center !important;color:#7d7d7d" colspan="30">暂无数据</td>
												</tr>
											</tbody>
										</table>
									</div>
									<!-- <div align="center" style="margin-top: 20px; margin-bottom: 20px;">
										<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
										<div class="pageBar pagination"></div>
										<div align="right" style="float: right;">
											<select style="width: 100px;" id="changePageNum">
												<option value="10">每页10条</option>
												<option value="20">每页20条</option>
												<option value="50">每页50条</option>
												<option value="100">每页100条</option>
												<option value="200">每页200条</option>
											</select>
										</div>
									</div> -->
								</div>
							</div>
						</div>
			    	</div>
			  </div>
			  <div class="layui-colla-item" index="11">
			    <h2 class="layui-colla-title">附件</h2>
			    <div class="layui-colla-content">
			    	<div>
						<table class="custom_table">
							<thead>
								<tr>
									<th>文档名称</th>
									<th>上传时间</th>
									<th>上传人</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody class="enclosure_message">
							</tbody>
						</table>
					</div>
			    </div>
			  </div>
			  <div class="layui-colla-item" index="12">
			    <h2 class="layui-colla-title">修改记录</h2>
			    <div class="layui-colla-content">
			    	<div>
						<table class="custom_table">
							<tbody class="record_message">
								
							</tbody>
						</table>
					</div>
					<div align="center" style="margin-top: 20px; margin-bottom: 20px;">
						<div align="left" style="padding-left: 15px; float: left;" class="_num"></div>
						<div class="pageBar pagination"></div>
						<div align="right" style="float: right;">
							<select style="width: 100px;height:30px;" class="changePageNum">
								<option value="10">每页10条</option>
								<option value="20">每页20条</option>
								<option value="50">每页50条</option>
								<option value="100">每页100条</option>
								<option value="200">每页200条</option>
							</select>
						</div>
						<div style="clear:both;"></div>
					</div>
			    </div>
			  </div>
			</div>
		</div>
	</div>
</body>
</html>
<script src="/resource/adimin/components/jquery.1x/dist/jquery.js"></script>
<script src="/resource/adimin/assets/js/ykp.js"></script>
<script src="/resource/adimin/assets/js/src/public.js"></script>

<script type="text/javascript">
	$(function(){
		var obj = {customer_id:ykp.getCookie('customer_id')};
		// console.log(obj);
		// console.log(1);

		var employees = {};//所有员工
		ykp.doAjax({
			async:false,
            url:'/api/api_employees/f7',
            method:'post',
            data:{
                select:'bmm_employees.id,bmm_employees.name'
            },
            success:function(res){
                var data = res.data;
                for(var i in data){
                    employees[data[i]['id']] =data[i]['name'] ;
                }
            }
        });

		layui.use('element',function(){
			var element = layui.element;

			//获取客户基本信息
			ykp.doAjax({
				url: "/api/api_customer/info",
				method: 'post',
				data: {
					filter: "khm_customer.id = " + obj.customer_id
				},
				success: function(res) {
					var data = res.data;
					$('.customer_name').text(data['khm_customer.name']);

					var rank = ['','普通','一般','重要'];
					var status = ['未合作','合作中','已解约'];

					var labels = data['label_list'];

					if(labels && labels.length > 0){
						var label_id = [];

						var html = [];
						for(var i in labels){
								html.push(
								`<label label-id="${labels[i]['id']}" class="btn btn-info btn-sm" style="color:white;border-radius:3px;padding:1px 4px;background-color:${labels[i]['color']} !important;margin-right:10px;">
									${labels[i]['title']}
								</label>`
							);
						}

						$('.labels').html(html.join(''));
					}

					var filter = '';
					$('.basic_message [basic]').each(function(i,e){
						filter = 'khm_customer.' + $(this).attr('basic');
						if($(this).attr('basic') == 'rank'){
							$(this).text(rank[data[filter]]);
							return true;
						}
						if($(this).attr('basic') == 'status'){
							$(this).text(status[data[filter]]);
							return true;
						}
						$(this).text(data[filter]);
					});
				}
			});

			//所属仓位
			ykp.doAjax({
				url: "/api/api_customer/get_customer_pos",
				method: 'post',
				data: {
					filter:'khm_contact_log.is_del <> 1',
					customer_id: obj.customer_id
				},
				success: function(res) {
					var data = res.data;
					var rele = data.rele;//关联公司

					if(rele && rele.length > 0){
						var rele_html = [];
						for(var i in rele){
							rele_html.push('<option value="'+ rele[i]['id'] +'">'+ rele[i]['name'] +'</option>');
						}
						$('.rele').html(rele_html.join(''));
						$('.rele').val(obj.customer_id);
					}
					
					$('.rele').change(function(){
						ykp.setCookie('customer_id',$(this).val());
						window.location = '/login/customer_detail';
					});


					if(data.log['name']){
						$('.basic_message [follow]').each(function(i,e){
							switch(i){
								case 0:
									$(this).text(data['log']['name']);
									break;z
								case 1:
									$(this).text(data['log']['last_modify_time'] != 0 ? cs.getNowTime(data['log']['last_modify_time']) : '');
									break;
								default:
									break;
							}
						});
					}

					if(data['pos']){
						$('.basic_message [position]').text(data['pos']['pos_name'] + data['pos']['pos_num']);
					}
				}
			});

			// element.on('collapse(demo1)',function(data){
			// 	if(data.show){
			// 		obj.page_size = 10;
			// 		var index = data.content.attr('index');

			// 		if(index == 0){
			// 			getGoodsList('/api/api_accountancies/inventory');
			// 		}
			// 		if(index == 1){
			// 			getGoodsList('/api/api_accountancies/index',1);
			// 		}
			// 		if(index == 2){
			// 			getGoodsList('/api/api_accountancies/index',2);
			// 		}
			// 	}
			// });

			element.on('collapse(one_level)', function(data){
				if(data.show){//得到当前面板的展开状态，true或者false
					obj.page_size = 10;
					var index = data.content.parent().attr('index'); //得到当前点击面板的index属性值
					index = parseInt(index);
					changePagesize(index);
					switch(index){
						case 1:
							abstract();
							break;
						case 2:
							info();
							break;
						case 3:
							contacts();
							break;
						case 4:
							service(element);
							break;
						case 5:
							team(element);
							break;
						case 6:
							contract(element);
							break;
						case 7:
							getmoney();
							break;
						case 8:
							expenditure();
							break;
						case 9:
							billing();
							break;
						case 10:
							goods(element);
							break;
						case 11:
							enclosure();
							break;
						case 12:
							amendantRecord();
							break;
						default:
							break;
					}
				}
			});
		});
		
		//切换每页条目数
		function changePagesize(index){
			$('.changePageNum').unbind('change').change(function(){
				obj.page_size = $(this).val();
				if(index == 3){
					getContactsList();
				}
				// if(index == 10){
				// 	if($(this).parents('.layui-colla-item').index() == 0){
				// 		getGoodsList('/api/api_accountancies/inventory');
				// 	}
				// 	if($(this).parents('.layui-colla-item').index() == 1){
				// 		getGoodsList('/api/api_accountancies/index',1);
				// 	}
				// 	if($(this).parents('.layui-colla-item').index() == 2){
				// 		getGoodsList('/api/api_accountancies/index',2);
				// 	}
				// }
				if(index == 8){
					getExpenditureList();
				}
				if(index == 9){
					getBillingList();
				}
				if(index == 12){
					getModifyRecords();
				}
			});
		}

		//获取最近联系记录
		function getRecentContactRecords(){
			ykp.doAjax({
				showBlock:true,
				url:'/api/api_contact_log/grid',
				method:'post',
				data:{
					filter:'khm_contact_log.is_del <> 1 and khm_contact_log.customer_id = ' + obj.customer_id,
					order:'khm_contact_log.log_time desc,khm_contact_log.id desc',
					limit:5,
					page:1
				},
				success:function(res){
					if(res.data.items == "") {
                       	ykp.prompt("暂无数据");
                       	$('.recent_contact_record').html('<div style="border:1px solid #ddd;text-align:center;height: 40px;line-height: 40px;">暂无数据</div>');
                        return;
                    }

					var data =res.data.items;
					var html = [];

					var contact_way = ['电话','微信','QQ','邮箱'];
		            var contact_type = ['售后服务','售前服务'];

					for(var i in data){
						html.push(
							`<div style="border-top:1px solid #eee;border-bottom:1px solid #eee; padding:14px 0 14px 0;">
								<div>
									<img style="width:40px;" src="${data[i]['last_info']['avatar']}">
									<span class="contact_person">${data[i]['last_info']['name']}</span>
									<span style="float:right;position:relative;top:8px;">
										${data[i]['khm_contact_log.log_time'] != 0 ? cs.getNowTime(data[i]['khm_contact_log.log_time'],true) : ''}
									</span>
								</div>
								<div style="margin-top:10px;padding-left:45px;text-align:right;">
									<span style="float:left;position:relative;top:4px;">
										${data[i]['khm_contact_log.contact_msg']}
									</span>
									<span style="background-color:#ccecff;padding:2px 8px;font-size:12px;color:#666; margin-right:5px;">
										${contact_type[--data[i]['khm_contact_log.contact_type']]}
									</span>
									<span style="background-color:#ccecff;padding:2px 8px;font-size:12px;color:#666;">
										${contact_way[--data[i]['khm_contact_log.contact_way']]}
									</span>
								</div>
							</div>`
						);
					}
					$('.recent_contact_record').html(html.join(''));
				}
			});
		}

		//摘要
		function abstract(){
			getRecentContactRecords();
		}

		//信息
		function info(){
			var employees = [];//所有员工
			var employees_2 = [];//所有员工id和部门id
			ykp.doAjax({
				async:false,
	            url:'/api/api_employees/f7',
	            method:'post',
	            data:{
	                select:'bmm_employees.id,bmm_employees.name,bmm_employees.department'
	            },
	            success:function(res){
	                var data = res.data;
	                for(var i in data){
	                    employees[data[i]['id']] =data[i]['name'] ;
	                    employees_2[data[i]['id']] = data[i]['department'];
	                }
	            }
	        });

			var customer_type = [];
		    //获取所有公海类型
		    ykp.doAjax({
		        url:'/api/api_customer_type/f7',
		        method:'post',
		        anysc:false,
		        data:{
		            select:'khm_customer_type.id,khm_customer_type.name'
		        },
		        success:function(res){
		            var data = res.data;
		            customer_type[0] = '无';
		            for(var i in data) {
		            	customer_type[data[i]['id']] =data[i]['name'];
		            }
		        }
		    });

		    var department = [];
			//获取所有部门
		    ykp.doAjax({
		        url:'/api/api_department/f7',
		        method:'post',
		        async:false,
		        data:{
		            select:'bmm_department.id,bmm_department.name,bmm_department.cid',
		            limit:999
		        },
		        success:function(res) {
		            var data = res.data;
		            console.log(data)
		            if (data != '') {
		            	department = data;
		            }
		        }
		    });

		    var lastdetail = [];
		    ykp.doAjax({
		    	showBlock:true,
		        url:'/api/api_customer/get_last',
		        method:'post',
		        async:false,
		        data:{
		        	customer_id:obj.customer_id,
		            limit:999
		        },
		        success:function(res) {
		        	lastdetail = res.data;
		        }
		    })

			ykp.doAjax({
				showBlock:true,
				url: "/api/api_customer/info",
				method: 'post',
				data: {
					filter: "khm_customer.id = " + obj.customer_id
				},
				success: function(res) {
					var data = res.data;
					var rank = ['', '普通', '一般', '重要'];
					var status = ['未合作','合作中','已解约'];
					var reason = ['无进行中的合同','合同已解约'];

					$('._message').find('td[data-title]').each(function() {
						for(var i in data) {
							if(i.replace(/khm_customer./, '') == $(this).attr('data-title')) {
								if(i.replace(/khm_customer./, '') == 'create_at' || i.replace(/khm_customer./, '') == 'stablish_time') {
									$(this).text(cs.getNowTime(data[i]));
								} else if (i.replace(/khm_customer./, '') == 'rank') {
									$(this).text(rank[data[i]]);
								} else if (i.replace(/khm_customer./, '') == 'status') {
									$(this).text(status[data[i]]);
								} else if (i.replace(/khm_customer./, '') == 'create_id') {
									$(this).text(employees[data[i]]);
								} else if (i.replace(/khm_customer./, '') == 'type') {
									$(this).text(customer_type[data[i]]);
								} else if(i.replace(/khm_customer./, '') == 'range'){
									$(this).attr('title',data[i]);
									$(this).text(data[i]);
								}else if(i.replace(/khm_customer./, '') == 'basic'){
									$(this).text(data[i] ? (data[i] == '1' ? '有' : '无') : '');
								} 
								else if(i.replace(/khm_customer./, '') == 'tax_type'){
									$(this).text(data[i] ? (data[i] == '1' ? '一般纳税人' : '小规模') : '');
								} else {
									$(this).text(data[i]);
								}
							}
						}

						if ($(this).attr('data-title') == 'reason') {
							$(this).text(lastdetail.contract['status']>=3?reason[lastdetail.contract.status-3]:'----');
						} else if ($(this).attr('data-title') == 'voiduser') {
							$(this).text(lastdetail.contract['status']>=3?lastdetail.contract.userInfo.name:'----');
						} else if ($(this).attr('data-title') == 'voiddept') {
							$(this).text(lastdetail.contract['status']>=3?lastdetail.contract.userInfo.dep_name:'----');
						} else if ($(this).attr('data-title') == 'create_dep') {
							$(this).text(department[employees_2[data['khm_customer.create_id']]-1]==undefined?'----':department[employees_2[data['khm_customer.create_id']]-1].name);
						} else if ($(this).attr('data-title') == 'update_by') {
							$(this).text(lastdetail.contract['update_by']=='0'?'----':employees[lastdetail.contract.update_by]);
						}
					})


					$('.layui-tab-item.layui-show').find('td[pos-id]').text($('.basic_message [position]').text());
				}
			})
		}

		//获取联系人数据
		function getContactsList(){
			ykp.list({
				url:'/api/api_contact_book/grid',
				method:'post',
				data:{
					filter:'khm_contact_book.customer_id = ' + obj.customer_id,
					limit:obj.page_size
				},
				pageBar:{
					id:'.pageBar'
				},
				loadList:function(res){
					if(res.data.items == "") {
                       	ykp.prompt("暂无数据");
                       	$('.contracts_message').html('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
                        return;
                    }

                    var _html = [];
                    var data = res.data.items;
                    var sexArr = ['','男','女','未知'];//性别
                    for(var i in data){
                    	_html.push(
                    		`<tr data-id="${data[i]['khm_contact_book.id']}">
                    		<td>${data[i]['khm_contact_book.num']}</td>
								<td>${data[i]['khm_contact_book.username']}</td>
								<td>${sexArr[data[i]['khm_contact_book.sex']]}</td>
								<td>${data[i]['khm_contact_book.phone']}</td>
								<td>${data[i]['khm_contact_book.telephone']}</td>
								<td>${data[i]['khm_contact_book.qq']}</td>
								<td>${data[i]['khm_contact_book.main_user'] == 1 ? '是' : '否'}</td>
								<td>${data[i]['khm_contact_book.is_main'] == 1 ? '是' : '否'}</td>
							</tr>`
                    	);
                    }

                    $('.contracts_message').html(_html.join(''));
				}
			});
		}

		//联系人
		function contacts(){
			getContactsList();
		}

		//服务
		function service(element){
			ykp.doAjax ({
				showBlock:true,
				url: "/api/api_service/get_customer_service",
				method: 'get',
				data: {
					customer_id:obj.customer_id
				},
				success: function(res) {
					var data = res.data;
					if(!data || data.length == 0){
						$('.service_message').html(
							`<div style="background-color: #c5e0f1;text-align:center;height: 40px;line-height: 40px;">
								暂无数据
							</div>`
						);
						return;
					}

					var data = res.data;
					var html =['<div class="layui-collapse" lay-accordion>'];
					var list;
					for(var i in data){
						list = data[i]['list'];
						html.push(
							`<div class="layui-colla-item" lay-filter="service">
							    <h2 class="layui-colla-title">
							    	<label>合同类型：长期合同</label>
							    	<i style="padding:0 20px;"></i>
							    	<label>订单编号：${data[i]['contract_code']}</label>
							    </h2>
							    <div class="layui-colla-content">
							    	${generateServiceTable(list).join('')}
							    </div>
							</div>`);
							}
					
					html.push('</div></div>');
					$('.service_message').html(html.join(''));

					element.init('collapse','service');
				}
			})
		}

		//生成服务信息td
		function generateServiceTable(list){
			var month;
			var html = [];
			html.push(
				`<div class="custom_table">
					<table class="">
						<thead>
							<tr>
								<th class="year"></th>
								<th>客服</th>
								<th>收单</th>
								<th>记单</th>
								<th>做账</th>
								<th>报税</th>
								<th>送单</th>
							</tr>
						</thead>
						<tbody class="all_service_data">`
			);

			var _html;
			var detail = {};
			var _detail = new Array(6);

			var index = ['', 'fa fa-circle-o', 'glyphicon glyphicon-ok', 'glyphicon glyphicon-remove'];

			if(list.length == 0){
				html.push('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
			}

			for(var i in list){
				month = i;
//				month = i.substring(4);

				detail = list[i];
				for(var k in detail){
					_detail[k - 1] = detail[k];
				}

				for(var k = 0;k < _detail.length;k++){
					if(_detail[k]){
						_html = $(
							`<tr class="service_icon">
								<td rowspan="2" class="month" get_money="${_detail[k]['get_money']}">
									${month}
								</td>
							</tr>
							<tr class="approve_time">
							</tr>`
						);
						break;
					}
				}
				for(var k = 0;k < _detail.length;k++){
					_html.eq(0).append(
						`<td conid="${_detail[k]['contract_id']}" type="t${_detail[k]['type']}">
							${_detail[k] ? (_detail[k]['status'] == 2 ? (_detail[k]['auth_id'] != '0' ? employees[_detail[k]['auth_id']] : '') : '') : ''}
						</td>`);
					_html.eq(2).append(
						`<td conid="${_detail[k]['contract_id']}" type="t${_detail[k]['type']}">
							${_detail[k] ? (_detail[k]['status'] == 2 ? (_detail[k]['auth_time'] != 0 ? cs.getNowTime(_detail[k]['auth_time'],true) : '' )  : '') : ''}
						</td>`);
				}
				html.push(_html.eq(0).prop('outerHTML'));
				html.push(_html.eq(1).prop('outerHTML'));
				html.push(_html.eq(2).prop('outerHTML'));
				_detail = [];
			}

			html.push('</tbody></table></div>');
			return html;
		}

		//团队
		function team(element){
			ykp.doAjax({
				showBlock:true,
				url: "/api/api_contract/get_contract_list2",
				method: 'get',
				data: {
					order:'htm_contract.contract_type desc',
					company_id:obj.customer_id
				},
				success: function(res) {
					var data = res.data;
					if(!data || data.length == 0){
						$('.team_message').html(
							`<div style="background-color: #c5e0f1;text-align:center;height: 40px;line-height: 40px;">
								暂无数据
							</div>`
						);
						return;
					}

					$('.team_message').html('');

					// var employees = [];//所有员工
					// ykp.doAjax({
					// 	async:false,
			  //           url:'/api/api_employees/f7',
			  //           method:'post',
			  //           data:{
			  //               select:'bmm_employees.id,bmm_employees.name'
			  //           },

			  //           success:function(res){
			  //               var data = res.data;
			  //               for(var i in data){
			  //                   employees[data[i]['id']] =data[i]['name'] ;
			  //               }
			  //           }
			  //       });

					var html =['<div class="layui-collapse" layui-filter="team">'];//折叠面板
					var _html = [];//面板内容
					var flow_detail = [];//流程详情
					var relation = [];//关注人 id
					var _relation = [];//关注人

					var tr = '';//面板内容中的每一条tr
					var num;
					for(var i in data){
						num = 1;
						staff_list = data[i]['staff_list'];

						_html.push(
							`<div class="custom_table" contract_id="${data[i]['id']}">
								<table style="margin-bottom:5px;">
									<thead>
										<tr>
											<th>序号</th>
											<th>${data[i]['contract_type'] == '1' ? '产品流程' : '产品名称'}</th>
											<th>负责人</th>
											<th>${data[i]['contract_type'] == '1' ? '关注人' : '协作人'}</th>
										</tr>
									</thead>
									<tbody>`
						);

						for(var k in staff_list){
							relation = staff_list[k]['relation_staff_id'].split(',');
							for(var z in relation){
								_relation.push(employees[relation[z]]);
							}
							
							_html.push(
								`<tr>
									<td>${num++}</td>
									<td>${data[i]['contract_type'] == '1' ? staff_list[k]['process'] : staff_list[k]['priduct_name']}</td>
									<td>${data[i]['contract_type'] == '1' ? (staff_list[k]['staff_id'] != '0' ? employees[staff_list[k]['staff_id']] : '') : (staff_list[k]['one_fuze'] != '0' ? employees[staff_list[k]['one_fuze']] : '')}</td>
									<td>${_relation.join(',')}</td>
								</tr>`
							);

							_relation = [];
							relation = [];
						}

	                	_html.push(
							`</tbody></table></div>`
						);

	                    html.push(
							`<div class="layui-colla-item">
							    <h2 class="layui-colla-title">
							    	<label>合同类型：</label>
							    	<label style="width:70px !important;text-align:left;display:inline-block;">${(data[i]['contract_type'] == 1 ? '长期合同' : '一次性合同')}</label>
							    	<i style="padding:0 20px;"></i>
							    	<label>订单编号：${data[i]['contract_code']}</label>
							    </h2>
							    <div class="layui-colla-content">
							    	${_html.join('')}
							    </div>
							</div>`
						);
	                    _html = [];
					}	
					
					html.push('</div></div>');
					$('.team_message').html(html.join(''));

					//重新渲染面板
					element.init('collapse','team');
				}
			})
		}

		//合同
		function contract(element){
			ykp.doAjax({
				showBlock:true,
				url: "/api/api_contract/grid",
				method: 'post',
				data: {
					filter: "khm_customer.id = " + obj.customer_id,
					order:'htm_contract.contract_type desc',
					limit:10
				},
				success: function(res) {
					var data = res.data.items;

					if(!data || data.length == 0){
						$('.conract_message').html(
							`<div style="background-color: #c5e0f1;text-align:center;height: 40px;line-height: 40px;">
								暂无数据
							</div>`
						);
						return;
					}

					$('.conract_message').html('');

					var service_product = [];//所有服务产品
					ykp.doAjax({
						async:false,
			            url:'/api/api_product/f7',
			            method:'post',
			            data:{
			                select:'ckm_product.id,ckm_product.name,ckm_product.type,ckm_product.price',
			                filter:'ckm_product.is_del <> 1'
			            },
			            success:function(res){
			                service_product = res.data;
			            }
			        });

					// var employees = [];//所有员工
					// ykp.doAjax({
					// 	async:false,
			  //           url:'/api/api_employees/f7',
			  //           method:'post',
			  //           data:{
			  //               select:'bmm_employees.id,bmm_employees.name'
			  //           },
			  //           success:function(res){
			  //               var data = res.data;
			  //               for(var i in data){
			  //                   employees[data[i]['id']] =data[i]['name'] ;
			  //               }
			  //           }
			  //       });

					var _html = [];
					var html =['<div class="layui-collapse" layui-filter="contract">'];

					var approve_statu = ['审核中','审核失败','审核成功'];//审批状态
		            var cStatus = ['未激活', '已激活', '已挂起', '已结束','已作废'];//合同状态
		            var cycle = {'1':'每月','3':'季度','6':'半年','12':'每年'};//维护周期
		            var source = ['','线上','线下'];//订单来源

					var salesman_id = [];//业务人员id
		            var salesman = [];//业务人员
		            var task = [];//任务
		            var task_detail = {};//任务详情

					for(var i in data){
						task_detail['product'] = [];
		                task = data[i]['task'];
		                salesman_id = data[i]['market'];
		                for(var k in salesman_id){
		                    salesman.push(salesman_id[k]['info']['name']);
		                }
		                
		                for(var k in task){
		                    if(k == 0){
		                        task_detail['start_time'] = task[k]['start_time'];
		                        task_detail['end_time'] = task[k]['end_time'];
		                    }

		                    if(k != 0){
		                        task_detail['start_time'] = task_detail['start_time'] > task[k]['start_time'] ? task[k]['start_time'] : task_detail['start_time'];
		                        task_detail['end_time'] = task_detail['end_time'] > task[k]['end_time'] ? task_detail['end_time'] : task[k]['end_time'];
		                    }

		                    if(data[i]['htm_contract.contract_type'] == 1 ){
		                        task_detail['pricing'] = task[k]['pricing'];
		                        task_detail['discount'] = task[k]['discount'];
		                        task_detail['count'] = task[k]['count'];
		                        task_detail['count_send'] = task[k]['count_send'];
		                    }

		                    if(data[i]['htm_contract.contract_type'] == 2 ){
		                        task_detail['pricing'] = '';
		                        task_detail['discount'] = '';
		                        task_detail['count'] = '';
		                        task_detail['count_send'] = '';
		                    }
		                     
		                    task_detail['product'].push(task[k]['productName']);
		                }

		                if(data[i]['htm_contract.contract_type'] == 1){
		                	_html.push(
								`<table class="message">
									<tr>
										<td class="unite-label">客户名称</td>
										<td data-title="name">${data[i]['khm_customer.name']}</td>
										<td class="unite-label">订单来源</td>
										<td data-title="is_source">${source[data[i]['htm_contract.is_source']]}</td>
									</tr>
									<tr>
										<td class="unite-label">合同类型</td>
										<td data-title="contract_type">${data[i]['htm_contract.contract_type'] == 1 ? '长期合同' : '一次性合同'}</td>
										<td class="unite-label">合同编码</td>
										<td data-title="contract_num">${data[i]['htm_contract.contract_num']}</td>
									</tr>
									<tr>
										<td class="unite-label">服务产品</td>
										<td data-title="productName">${task_detail['product']}</td>
										<td class="unite-label">数量</td>
										<td data-title="count">${task_detail['count']}</td>
									</tr>
									<tr>
										<td class="unite-label">赠送</td>
										<td data-title="count_send">${task_detail['count_send']}</td>
										<td class="unite-label">标准价</td>
										<td data-title="pricing">${task_detail['pricing']}</td>
									</tr>
									<tr>
										<td class="unite-label">折扣价</td>
										<td data-title="discount">${task_detail['discount']}</td>
										<td class="unite-label">折后总额</td>
										<td data-title="discount_total">${data[i]['htm_contract.discount_total']}</td>
									</tr>
									<tr>
										<td class="unite-label">账本费</td>
										<td data-title="account_book">${data[i]['htm_contract.account_book']}</td>
										<td class="unite-label">维护周期</td>
										<td data-title="payment_cycle">${cycle[data[i]['htm_contract.payment_cycle']]}</td>
									</tr>
									<tr>
										<td class="unite-label">合同总额</td>
										<td data-title="total">${eval(data[i]['htm_contract.account_book'] + '+' + data[i]['htm_contract.discount_total'])}</td>
										<td class="unite-label">收款周期</td>
										<td data-title="get_cycle">${data[i]['htm_contract.get_cycle']}个月</td>
									</tr>
									<tr>
										<td class="unite-label">业务员</td>
										<td colspan="3" data-title="market">${salesman.join(',')}</td>
									</tr>
									<tr>
										<td class="unite-label">签约时间</td>
										<td data-title="signed_time">${data[i]['htm_contract.signed_time'] != '0' ? cs.getNowTime(data[i]['htm_contract.signed_time']) : ''}</td>
		                                <td class="unite-label">发票认证</td>
		                                <td data-title="is_tax">${data[i]['htm_contract.is_tax'] == '0' ? '否' : '是'}</td>
									</tr>
									<tr>
										<td class="unite-label">开始时间</td>
										<td data-title="start_time">${task_detail['start_time'] != 0 ? cs.getNowTime(task_detail['start_time']) : ''}</td>
										<td class="unite-label">截至时间</td>
										<td data-title="end_time">${task_detail['end_time'] != 0 ? cs.getNowTime(task_detail['end_time']) : ''}</td>
									</tr>
									<tr>
										<td class="unite-label">合同状态</td>
										<td data-title="status">${cStatus[data[i]['htm_contract.status']]}</td>
										<td class="unite-label">备注</td>
										<td data-title="remark">${data[i]['htm_contract.remark']}</td>
									</tr>
									<tr>
										<td class="unite-label">创建人</td>
										<td data-title="create_by">${employees[data[i]['htm_contract.create_by']]}</td>
										<td class="unite-label">创建时间</td>
										<td data-title="create_time">${data[i]['htm_contract.create_time'] !=  '0' ? cs.getNowTime(data[i]['htm_contract.create_time']) : ''}</td>
									</tr>
									<tr>
										<td class="unite-label">已收款金额</td>
										<td data-title="get_money">${data[i]['htm_contract.get_money']}</td>
										<td class="unite-label">待收款金额</td>
										<td data-title="name">${eval(data[i]['htm_contract.total_monry']+'-'+data[i]['htm_contract.get_money'])}</td>
									</tr>
								</table>`
							);
		                }

		                if(data[i]['htm_contract.contract_type'] == 2){
		                	_html.push(
								`<table class="message">
									<tr>
										<td class="unite-label">客户名称</td>
										<td colspan="3" data-title="name">${data[i]['khm_customer.name']}</td>
									</tr>
									<tr>
										<td class="unite-label">合同类型</td>
										<td data-title="contract_type">${data[i]['htm_contract.contract_type'] == 1 ? '长期合同' : '一次性合同'}</td>
										<td class="unite-label">合同编码</td>
										<td data-title="contract_num">${data[i]['htm_contract.contract_num']}</td>
									</tr>
									<tr>
										<td class="unite-label">服务项目</td>
										<td data-title="productName">${task_detail['product']}</td>
										<td class="unite-label">合同金额</td>
										<td data-title="discount_total">${data[i]['htm_contract.discount_total']}</td>
									</tr>
									<tr>
										<td class="unite-label">业务员</td>
										<td data-title="market">${salesman.join(',')}</td>
										<td class="unite-label">签约时间</td>
										<td data-title="signed_time">${data[i]['htm_contract.signed_time'] != '0' ? cs.getNowTime(data[i]['htm_contract.signed_time']) : ''}</td>
									</tr>
									<tr>
										<td class="unite-label">开始时间</td>
										<td data-title="start_time">${task_detail['start_time'] != 0 ? cs.getNowTime(task_detail['start_time']) : ''}</td>
										<td class="unite-label">截至时间</td>
										<td data-title="end_time">${task_detail['end_time'] != 0 ? cs.getNowTime(task_detail['end_time']) : ''}</td>
									</tr>
									<tr>
										<td class="unite-label">合同状态</td>
										<td data-title="status">${cStatus[data[i]['htm_contract.status']]}</td>
										<td class="unite-label">备注</td>
										<td data-title="remark">${data[i]['htm_contract.remark']}</td>
									</tr>
									<tr>
										<td class="unite-label">创建人</td>
										<td data-title="create_by">${employees[data[i]['htm_contract.create_by']]}</td>
										<td class="unite-label">创建时间</td>
										<td data-title="create_time">${data[i]['htm_contract.create_time'] !=  '0' ? cs.getNowTime(data[i]['htm_contract.create_time']) : ''}</td>
									</tr>
									<tr>
										<td class="unite-label">已收款金额</td>
										<td data-title="get_money">${data[i]['htm_contract.get_money']}</td>
										<td class="unite-label">待收款金额</td>
										<td data-title="name">${eval(data[i]['htm_contract.total_monry']+'-'+data[i]['htm_contract.get_money'])}</td>
									</tr>
								</table>`
							);
		                }

	                    html.push(
							`<div class="layui-colla-item">
							    <h2 class="layui-colla-title">
							    	<label>合同类型：</labe>
							    	<label style="width:70px !important;text-align:left;display:inline-block;">${(data[i]['htm_contract.contract_type'] == 1 ? '长期合同' : '一次性合同')}</label>
							    	<i style="padding:0 20px;"></i>
									    	<label>签约时间：${data[i]['htm_contract.signed_time'] != '0' ? cs.getNowTime(data[i]['htm_contract.signed_time']) : ''}</label>
							    	<i style="padding:0 20px;"></i>
							    	<label>订单编号：${data[i]['htm_contract.contract_code']}</label>
							    </h2>
							    <div class="layui-colla-content">${_html.join('')}</div>
							</div>`
						);

						salesman_id = [];
	                    salesman = [];
	                    tasks = [];
	                    task_detail = {};
	                    _html = [];
					}
					html.push('</div>');
					$('.conract_message').html(html.join(''));

					element.init('collapse','contract');
				}
			})
		}

		//收款
		function getmoney(){
			getGatheringList();
		}

		//获取收款列表
		function getGatheringList(){
			var pagesize = 10;
//			ykp.doAjax({
//				showBlock:true,
//				url: '/api/api_finance/qklist',
//				method: 'post',
//				data: {
//					page_size: 999,
//					where: 'htm_contract.customer_id = ' + obj.customer_id,
//					page:1
//				},
//				success:function(res){
//					var data = res.data.items;
//					if(!data || data.length == 0){
//						$('.sk_jz').eq(0).find('tbody').html(
//							`<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>`
//						);
//						return;
//					}
//					var html = [];
//					var info;
//					var _info = [];
//					for(var i in data){
//						info = data[i]['list'];
//
//						for(var k in info){
//							_info[info[k]['time'].substring(4) - 1] = {get_money:info[k]['get_money'],money_status:info[k]['money_status']};
//						}
//
//						html.push(
//							`<tr conid="${data[i]['contract_id']}">
//								<td>${data[i]['info']['htm_contract.contract_code']}</td>
//								<td>${data[i].overdue}</td>
//								<td>${data[i].yq_money}元</td>`
//						);
//
//
//						for(var k=0;k<12;k++){
//							html.push(generateTd(_info[k]));
//						}
//
//						html.push('</td>');
//						_info = [];
//					}
//					$('.sk_jz').find('tbody').html(html.join(''));
//				}
//			})
			
			ykp.list({
						url:'/api/api_finance/receivables_list',
						method:'post',
						data:{
							limit:pagesize,
							filter: 'khm_customer.id = ' + obj.customer_id,
							page:1
						},
						pageBar:{
							id:'.pageBar'
						},
						loadList:function(res){
							var data = res.data.items;
							if(!data || data.length == 0){
								$('#templateCon .layui-tab-item.layui-show .custom_table').eq(1).find('tbody').html(
									`<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>`
								);
								return;
							}

							var html = '';
							var get_way = ['', '现金', '支付宝', '微信', '银行卡'];
							var sstatus = ['', '待审核', '通过', '未通过'];
							var ths = $('#dynamic-table .thColor th');
							var styles = [];
							for(i = 0; i < ths.length; i++) {
								styles.push(ths.eq(i).css('display'));
							}
							console.log(styles[3]);
							//审批权限为true可以审批,为false不可审批
							var spApp = cs.approve_authority({
								name: '收款',
								nodes: [163]
							});
							var cxApp = cs.approve_authority({
								name: '收款',
								nodes: [271]
							});
							var product_name = {};
							var arr = [];
							for(var i in data) {
								if(data[i]['product_name']) {
									arr = [];
									data[i]['product_name'].forEach(function(item) {
										arr.push(item.name);
									})
									product_name[i] = arr.join(',');
								} else {
									product_name[i] = data[i]['cwm_receivables.product_name'];
								}
							}
							
							var customer_name;
							for(var i in data) {
								customer_name = '<a class="customerDetail pos-rel" href="#">' + data[i]['khm_customer.name'] + '</a> ' +
									'<label class="pos-rel"> <i class="iconBnt fa fa-info-circle" style="color:' + (data[i]['Remark'].length > 0 ? 'red' : "") + '"  data-rel="tooltip" data-placement="right" data-html="true" title="' + cs.getRemark(data[i]["Remark"]) + '" ></i></label>';
								html +=
									'<tr data-id="' + data[i]['cwm_receivables.id'] + '" data-status="' + data[i]['cwm_receivables.status'] + '">' +
									'<td style="display: ' + styles[2] + '" data-num="1"><sapn class="cedit">' + data[i]['cwm_receivables.num'] + '</span></td>' +
									'<td data-cid="' + data[i]['khm_customer.id'] + '" style="display:' + styles[3] + '" data-num="2"><a class="customerDetail pos-rel" href="#">' + (data[i]['cwm_receivables.customer_id'] != '0' ? customer_name : data[i]['cwm_receivables.customer_name']) + '</a></td>' +
									'<td style="display: ' + styles[4] + '" data-num="3"><sapn class="cedit">' + (data[i]['cwm_receivables.order_id'] != '0' ? data[i]['cwm_receivables.order_id'] : '') + '</sapn></td>' +
									'<td style="display: ' + styles[5] + '" data-num="4"><sapn class="cedit">' + product_name[i] + '</sapn></td>' +
									'<td style="display: ' + styles[6] + '" data-num="5" data-status="' + data[i]['cwm_receivables.status'] + '"><sapn class="cedit">' + sstatus[data[i]['cwm_receivables.status']] + '</sapn></td>' +
									'<td style="display: ' + styles[7] + '" data-num="6"><sapn class="cedit">' + data[i]['cwm_receivables.confirm_remark'] + '</sapn></td>' +
									'<td style="display: ' + styles[8] + '" data-num="7"><sapn class="cedit">' + (data[i]['cwm_receivables.get_time'] != '0' ? ykp.formatDate(new Date(parseInt(data[i]['cwm_receivables.get_time'] * 1000)), 'Y-M-d') : '') + '</sapn></td>' +
									'<td style="display: ' + styles[9] + '" data-num="8"><sapn class="cedit">' + (parseInt(data[i]['cwm_receivables.get_money'])+parseInt(data[i]['cwm_receivables.get_account_book'])).toFixed(2) + '</sapn></td>' +
									'<td style="display: ' + styles[10] + '" data-num="9"><sapn class="cedit">' + get_way[data[i]['cwm_receivables.get_way']] + '</sapn></td>' +
									'<td style="display: ' + styles[11] + '" data-num="10"><sapn class="cedit">' + data[i]['xtm_kh_bank.bank_name'] + '</sapn></td>' +
									'<td style="display: ' + styles[12] + '" data-num="11"><sapn class="cedit">' + (data[i]['cwm_receivables.receiver'] ? employees[data[i]['cwm_receivables.receiver']] : '') + '</sapn></td>' +
									'<td style="display: ' + styles[13] + '" data-num="12"><sapn class="cedit">' + data[i]['cwm_receivables.remark'] + '</sapn></td>' +
									'</tr>'
							};
							$('#templateCon .layui-tab-item.layui-show .custom_table').eq(1).find('tbody').html(html);
							$('.sk_qt').find('tbody').html(html);
											
						}
					})
			
			
//			ykp.doAjax({
//				showBlock:true,
//				url: '/api/api_finance/qk_other_list',
//				method: 'post',
//				data: {
//					page_size: 999,
//					where: 'htm_contract.customer_id = ' + obj.customer_id,
//					page:1
//				},
//				success:function(res){
//					var data = res.data.items;
//					if(!data || data.length == 0){
//						$('.sk_qt').find('tbody').html(
//							`<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>`
//						);
//						return;
//					}
//
//					var html = [];
//					var salesman_id = [];//业务人员id
//		            var salesman = [];//业务人员
//		            var task = [];//任务
//		            var task_detail = {};//任务详情
//
//					for(var i in data){
//						    task_detail['product'] = [];
//			                task = data[i]['task'];
//
//			                salesman_id = data[i]['market'];
//			                for(var k in salesman_id){
//			                    salesman.push(salesman_id[k]['info']['name']);
//			                }
//
//			                
//			                for(var k in task){
//			                    if(k == 0){
//			                        task_detail['start_time'] = task[k]['start_time'];
//			                        task_detail['end_time'] = task[k]['end_time'];
//			                        if(task[k]['staff'].length > 0){
//			                        	task_detail['leader'] = task[k]['staff'][k]['user']['name'] ? task[k]['staff'][k]['user']['name'] : '';
//			                        }
//			                    }
//
//			                    if(k != 0){
//			                        task_detail['start_time'] = task_detail['start_time'] >= task[k]['start_time'] ? task[k]['start_time'] : task_detail['start_time'];
//			                        task_detail['end_time'] = task_detail['end_time'] > task[k]['end_time'] ? task_detail['end_time'] : task[k]['end_time'];
//			                    }
//
//			                    task_detail['product'].push(task[k]['productName']);
//			                }
//
//			                html.push(
//			                	`<tr conid="${data[i]['htm_contract.id']}" >
//			                        <td>${data[i]['htm_contract.contract_code']}</td>
//			                        <td>${salesman.join(',')}</td>
//			                        <td>${task_detail['leader'] ? task_detail['leader'] : ''}</td>
//			                        <td>${task_detail['product'].join(',')}</td>
//			                        <td></td>
//			                        <td>${cs.getNowTime(task_detail['start_time'])} — ${cs.getNowTime(task_detail['end_time'])}</td>
//			                        <td>未完成</td>
//			                        <td>${data[i]['htm_contract.discount_total']}</td>
//			                        <td>${data[i]['htm_contract.get_money']}</td>
//			                        <td>${eval(data[i]['htm_contract.total_monry'] + '-' + data[i]['htm_contract.get_money'])}</td>
//			                    </tr>`
//			                );
//
//		                    salesman_id = [];//业务人员id
//		                    salesman = [];//业务人员
//		                    task = [];//任务
//		                    task_detail = {};//任务详情
//					}
//
//					$('.sk_qt').find('tbody').html(html.join(''));
//				}
//			})
		}

		//生成记账报税欠款td
		function generateTd(_obj){
			if(!_obj){
				return `<td get_money></td>`;
			}
			var index = ['', 'fa fa-circle-o', 'glyphicon glyphicon-ok', 'glyphicon glyphicon-remove'];
			return `<td get_money="${_obj['get_money']}" money_status="${_obj['money_status']}"><label class="${index[_obj['money_status']]}"></label></td>`;
		}

		//支出
		function expenditure(){
			getExpenditureList();
		}

		//获取支出列表
		function getExpenditureList(){
			//console.log(obj);
			ykp.list({
				url:'/api/api_finance/expenditure_list',
				method:'post',
				data:{
					limit:obj.page_size,
					filter:"cwm_expenditure.object_type = 1 and cwm_expenditure.object = " + obj.customer_id
				},
				pageBar:{
					id:'.pageBar'
				},
				loadList:function(res){
					var data = res.data.items;

					if(!data || data.length == 0){
						$('.expenditrue_message').html('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
						return;
					}

					var _html = [];

					//审批状态
					var status = ['审核中', '审批失败', '审批成功'];
					//支出类别
					var give_types = ['','退款', '费用', '报销'];
					//支付方式
					var give_ways = ['','现金','支付宝','微信','银行卡'];

					for(var i in data){
						_html.push(
							`<tr data-id="${data[i]['cwm_expenditure.id']}">
								<td>${data[i]['cwm_expenditure.id']}</td>
								<td>${data[i]['cwm_expenditure.order_id']}</td>
								<td>${status[data[i]['cwm_expenditure.status']]}</td>
								<td>${data[i]['cwm_expenditure.give_time'] != '0' ? cs.getNowTime(data[i]['cwm_expenditure.give_time']) : ''}</td>
								<td>${data[i]['cwm_expenditure.give_money']}</td>
								<td>${give_types[data[i]['cwm_expenditure.give_way']]}</td>
								<td>${give_ways[data[i]['cwm_expenditure.give_type']]}</td>
								<td>${data[i]['cwm_expenditure.accounts']}</td>
								<td>${data[i]['cwm_expenditure.duty_name']}</td>
								<td>${data[i]['cwm_expenditure.remark']}</td>
							</tr>`
						)
					}

					$('.expenditrue_message').html(_html.join(''));
				}
			})
		}

		//开票
		function billing(){
			getBillingList();
		}

		//获取开票列表
		function getBillingList(page_size,id){
			ykp.list({
				url:'/api/api_comprehensive_bill/grid',
				method:'post',
				data:{
					page_size:obj.page_size,
					filter:"zhm_comprehensive_bill.customer_id = " + obj.customer_id
				},
				pageBar:{
					id:'.pageBar'
				},
				loadList:function(res){
					var data = res.data.items;
					
					if(!data || data.length == 0){
						$('.billing_message').html('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
						return;
					}
					var _html = [];

					//审批状态
					var status = ['审核中', '审批失败', '审批成功'];

					for(var i in data){
						_html.push(
							`<tr data-id="${data[i]['zhm_comprehensive_bill.id']}">
								<td>${data[i]['zhm_comprehensive_bill.bill_id']}</td>
								<td>${data[i]['khm_customer.name']}</td>
								<td>${data[i]['zhm_comprehensive_bill.order_number']}</td>
								<td>${status[data[i]['zhm_comprehensive_bill.status']]}</td>
								<td>${data[i]['zhm_comprehensive_bill.bill_date'] != '0' ? cs.getNowTime(data[i]['zhm_comprehensive_bill.bill_date']) : ''}</td>
								<td>${data[i]['zhm_comprehensive_bill.bill_money']}</td>
								<td>${data[i]['zhm_comprehensive_bill.bill_type'] == 1 ? '增值税专用发票' : '普通'}</td>
								<td>${data[i]['zhm_comprehensive_bill.bill_number']}</td>
								<td>${data[i]['zhm_comprehensive_bill.>bill_header_type'] == 1 ? '公司' : '个人'}</td>
								<td>${data[i]['zhm_comprehensive_bill.bill_header']}</td>
								<td>${data[i]['khm_customer.social_credit_code']}</td>
							</tr>`
						)
					}

					$('.billing_message').html(_html.join(''));
				}
			})
		}

		//物品
		function goods(element) {
			element.init('collapse');
			element.on('collapse(demo1)', function(data){
			  	//得到当前面板的展开状态，true或者false
			  	if(data.show){
			  		// console.log(data);
			  		// console.log(1);
			  	  	if(data['content'].attr('index') == 0){
						getGoodsList(1,data['content'].find('tbody'));
					}
					if(data['content'].attr('index') == 1){
						getGoodsList(2,data['content'].find('tbody'));
					}
					if(data['content'].attr('index') == 2){
						getGoodsList(3,data['content'].find('tbody'));
					}
			  	}
			});
			// getGoodsList('/api/api_accountancies/inventory',10,id);
			// element.init('collapse');
		}

		//获取物品列表
		function getGoodsList(type,ele){
			// console.log(ele);
			// var filter;
			// if(url.indexOf('inventory') != '-1'){
			// 	filter = 'ckm_inventory.customer_id = ' + id;
			// }
			// if(url.indexOf('inventory') == '-1'){
			// 	filter = 'customer_id = ' + id;
			// }
			ykp.doAjax({
				url:'/api/api_accountancies/get_num_info',
				method:'post',
				data:{
					customer_id:obj.customer_id,
					type:type
				},
				success:function(res){
					var data = res.data;
					if(!data || data.length == 0){
						$('#templateCon .layui-colla-content.layui-show tbody').html(
							`<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>`
						);
						return;
					}
					handleGoodsData(data,ele);
				}
			});
		}

		//处理物品数据
		function handleGoodsData(data,ele){
			var goods_html = [];

			for(var i in data){
				goods_html.push(
					`<tr>
						<td style="width:10%;">物品名称</td>
						<td style="width:40%;">${data[i]['goods']}</td>
						<td style="width:10%;">物品数量</td>
						<td style="width:40%;">${data[i]['count']}</td>
					</tr>`
				);
			}
			// if(!type){
			// 	var Status = ['未审核','未通过','已通过'];  //审核状态
			// 	var Type = ['','凭证','单据','证件'];  //仓库名称
			// 	for(var i in data){
			// 		html.push(
			// 			`<tr data-id="${data[i]['ckm_inventory.id']}">
			// 				<td>${data[i]['ckm_inventory.num']}</td>
			// 				<td>${data[i]['ckm_inventory.pd_time'] != 0 ? cs.getNowTime(data[i]['ckm_inventory.pd_time']) : ''}</td>
			// 				<td>${Type[data[i]['ckm_inventory.type']]}仓</td>
			// 				<td>${1}</td>
			// 				<td>${data[i]['ckm_inventory.kc_goods']}</td>
			// 				<td>${data[i]['ckm_inventory.kc_num']}</td>
			// 				<td>${data[i]['ckm_inventory.pd_num']}</td>
			// 				<td>${data[i]['ckm_inventory.pd_kc']}</td>
			// 				<td>${1}</td>
			// 				<td>${employees[data[i]['ckm_inventory.create_id']]}</td>
			// 				<td>${data[i]['ckm_inventory.create_at'] !='0' ? cs.getNowTime(data[i]['ckm_inventory.create_at']) : ''}</td>
			// 			</tr>`
			// 		)
			// 	}
			// }

			// if(type == 1){
			// 	var Type = ['','凭证','单据','证件'];  //入库类型
			// 	for(var i in data){
			// 		html.push(
			// 			`<tr data-id="${data[i]['ckm_in_warehouse.id']}">
			// 				<td>${data[i]['ckm_in_warehouse.num']}</td>
			// 				<td>${Type[data[i]['ckm_in_warehouse.type']]}</td>
			// 				<td>${Type[data[i]['ckm_in_warehouse.type']]}仓</td>
			// 				<td>${employees[data[i]['ckm_in_warehouse.jb_id']]}</td>
			// 				<td>${data[i]['ckm_in_warehouse.time'] !=0 ? cs.getNowTime(data[i]['ckm_in_warehouse.time']) : ''}</td>
			// 				<td>${data[i]['ckm_in_warehouse.goods']}</td>
			// 				<td>${data[i]['ckm_in_warehouse.number']}</td>
			// 				<td>${employees[data[i]['ckm_in_warehouse.create_id']]}</td>
			// 				<td>${data[i]['ckm_in_warehouse.create_time'] !=0 ? cs.getNowTime(data[i]['ckm_in_warehouse.create_time']) : ''}</td>
			// 			</tr>`
			// 		)
			// 	}
			// }

			// if(type == 2){
			// 	var Type = ['','证件','凭证','票据'];  //仓库名称

			// 	for(var i in data){
			// 		html.push(
			// 			`<tr data-id="${data[i]['ckm_out_warehouse.id']}">
			// 				<td>${data[i]['ckm_out_warehouse.num']}</td>
			// 				<td>${Type[data[i]['ckm_out_warehouse.type']]}</td>
			// 				<td>${Type[data[i]['ckm_out_warehouse.type']]}仓</td>
			// 				<td>${employees[data[i]['ckm_out_warehouse.jb_id']]}</td>
			// 				<td>${data[i]['ckm_out_warehouse.time'] !=0 ? cs.getNowTime(data[i]['ckm_out_warehouse.time']) : ''}</td>
			// 				<td>${data[i]['ckm_out_warehouse.goods']}</td>
			// 				<td>${data[i]['ckm_out_warehouse.number']}</td>
			// 				<td>${employees[data[i]['ckm_out_warehouse.create_id']]}</td>
			// 				<td>${data[i]['ckm_out_warehouse.create_time'] !=0 ? cs.getNowTime(data[i]['ckm_out_warehouse.create_time']) : ''}</td>
			// 			</tr>`
			// 		)
			// 	}
			// }
			
			ele.html(goods_html.join(''));

			// $('.layui-tab-content>div').eq(9).find('.layui-colla-item tbody tr').click(function(){
			// 	// var index = $(this).parents('.layui-colla-itemd').index();
			// 	// var id = $(this).attr('data-id');
			// 	var _url = '?url=depotCheck&i=0-4-3&type=1';
			// 	// if (index == 0) {
			// 	// 	_url = '?url=depotCheck&i=0-4-3&type=1';//盘点
			// 	// } else if (index == 1) {
			// 	// 	_url = '?url=depotStorage&i=0-4-0&type=1';//入库
			// 	// } else {
			// 	// 	_url = '?url=depotOutGo&i=0-4-1&type=1';//出库
			// 	// }
			// 	ykp.setCookie('detailsId',id,1/24);
			// 	//window.location = _url;
			// 	skPage(_url);
			// })
			
			// element.init('collapse');

		}

		//附件
		function enclosure(){
			ykp.doAjax({
				url:'/api/api_customer/get_customer_file',
				method:'post',
				data:{
					customer_id:obj.customer_id
				},
				success:function(res){
					var data = res.data;
					if(!data || data.length == 0){
						$('.enclosure_message').html('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
						return;
					}
					var _data = data['file'].concat(data['image']);
					var _html = [];

					for(var i in _data){
						_html.push(
							`<tr>
								<td>${_data[i]['name']}</td>
								<td>${_data[i]['create_at'] != 0 ? cs.getNowTime(_data[i]['create_at']) : ''}</td>
								<td>${_data[i]['create_info']['name']}</td>
								<td>
									<button class="loadFile" url="${_data[i]['url']}" style="padding:4px 10px 5px 10px;background:#428bca;color:#fff;border:none;">下载</button>
								</td>
							</tr>`
						)
					}
					
					$('.enclosure_message').html(_html.join(''));
					loadEnenclosure();
				}
			})
		}

		//下载附件
		function loadEnenclosure(){
			$('.loadFile').click(function(){
				window.open($(this).attr('url'));
			});
		}

		//修改记录
		function amendantRecord(){
			getModifyRecords();
		}

		//获取修改记录
		function getModifyRecords(){
			ykp.list({
				url:'/api/api_customer/customer_record',
				method:'post',
				data:{
					customer_id:obj.customer_id,
					limit:obj.page_size
				},
				pageBar:{
					id:'.pageBar'
				},
				loadList:function(res){
					var data = res.data.items;
					if(!data || data.length == 0){
						$('.record_message').html('<tr><td colspan="30" style="color:#7d7d7d;text-align:center !important;">暂无数据</td></tr>');
						return;
					}

					var html = [];
					var operations = ['','添加','编辑','删除'];
					for(var i in data){
						html.push(
							`<tr>
								<td style="text-align:left;font-size:16px;">
									${cs.getNowTime(data[i]['khm_update_record.create_at'])}，
									<span>${employees[data[i]['khm_update_record.user_id']]}</span>
									<span>${operations[data[i]['khm_update_record.type']]}了</span>
									<a href="javascript:;">${data[i]['khm_update_record.content']}</a>
								</td>
							</tr>`
						);
					}

					$('.record_message').html(html.join(''));
				}
			});
		}
	});
</script>